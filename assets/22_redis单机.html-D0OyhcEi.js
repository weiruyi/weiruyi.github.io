import{_ as r}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as o,c as n,a as c,d as s,w as a,e as l,f as e,b as i,o as d}from"./app-BPEkgqoy.js";const u="/image/redis/redis21.png",h="/image/redis/redis22.png",_="/image/redis/redis23.jpg",p="/image/redis/redis24.png",T="/image/redis/redis25.png",Q="/image/redis/redis26.png",m="/image/redis/redis27.png",g="/image/redis/redis28.png",E="/image/redis/redis29.png",v="/image/redis/redis30.png",b="/image/redis/redis31.png",f={},R=i('<h1 id="redis单机" tabindex="-1"><a class="header-anchor" href="#redis单机"><span>Redis单机</span></a></h1><h2 id="一、数据库" tabindex="-1"><a class="header-anchor" href="#一、数据库"><span>一、数据库</span></a></h2><h3 id="_1、实现" tabindex="-1"><a class="header-anchor" href="#_1、实现"><span>1、实现</span></a></h3><p>Redis服务器将所有数据库都保存在服务器状态redis.h/redisServer结构的db数组中，db数组的每个项都是一个redis.h/redisDb结构，每个redisDb结构代表一个数据库。数组长度（数据库数量）由dbnum控制，默认有16个，通过<code>SELECT</code>命令切换数据库。</p><p>RedisClient结构中的db属性指向当前所使用的数据库，SELECT命令原理即修改该指针。</p>',5),D=l("img",{src:u,style:{zoom:"50%"}},null,-1),y=i('<h3 id="_2、键空间" tabindex="-1"><a class="header-anchor" href="#_2、键空间"><span>2、键空间</span></a></h3><p>Redis是一个键值对K-V数据库服务器，服务器中的每个数据库都由一个redis.h/redisDb结构表示，其中，redisDb结构的dict字典保存了数据库中的所有键值对，这个字典称为键空间（key space）。所有针对数据库中数据的操作本质上都是对键空间字典的操作，同时也会进行一些维护：</p><ul><li>读写键时，会记录键空间命中/不命中次数</li><li>更新键的LRU时间</li><li>删除读取到的过期键</li><li>watch命令监视某个键时，修改后标记dirty，告知事务程序</li><li>根据配置发送相应的通知</li></ul><h3 id="_3、过期回收" tabindex="-1"><a class="header-anchor" href="#_3、过期回收"><span>3、过期回收</span></a></h3><ul><li><code>Expire | pExpire | ExpireAt | pExpireAt &lt;key&gt; &lt;time&gt;</code>指定键的过期时间，单位s，p开头的命令单位ms <ul><li>实现上前三个最终都调用pExpireAt实现</li><li>底层在redisDb结构的expires字典保存所有键的过期时间，称过期字典。其键指向某个键的对象，其值是long long类型整数，表示ms精度的Unix时间戳</li></ul></li><li><code>TTL | pTTL &lt;key&gt;</code>返回剩余生存时间，即查询键的过期时间和当前时间之差</li><li><code>Persist &lt;key&gt;</code>移除某个键的过期时间，即删除过期字典的某个键值对</li></ul>',5),A=l("img",{src:h,style:{zoom:"50%"}},null,-1),L=i(`<ul><li>不同的回收策略： <ul><li>定时删除：创建定时器自动删除。内存友好，但消耗CPU时间</li><li>惰性删除：访问键时才执行判断删除。CPU友好，但容易造成部分键长时间无法删除</li><li>定期删除：每隔一段时间执行一次过期删除。上面两种方法的综合，但难以确定执行的频率和时长</li></ul></li><li>Redis的回收策略：惰性删除 + 定期删除 <ul><li>惰性删除由db.c/expireIfNeeded函数实现。算法同上</li><li>定期删除由redis.c/activeExpireCycle函数实现。在规定时间内，分多次遍历服务器中的各个数据库，从expires字典中随机检查一部分键的过期时间，并删除过期键。</li></ul></li></ul><h3 id="_4、aof、rdb和复制功能对过期键的处理" tabindex="-1"><a class="header-anchor" href="#_4、aof、rdb和复制功能对过期键的处理"><span>4、AOF、RDB和复制功能对过期键的处理</span></a></h3><ul><li><p>RDB持久化：</p><ul><li>保存时，过期键不会写入新创建的RDB文件；</li><li>载入时，如果是主服务器模式，过期键不会加载</li><li>载入时，如果是从服务器模式，过期键依然会加载，由主从同步保证数据一致性</li></ul></li><li><p>AOF持久化:</p><ul><li>保存时没有任何影响。但过期删除后，会向AOF文件追加DEL命令，显式记录该键已删除</li><li>重写时过期键不会写入</li></ul></li><li><p>复制功能：由主服务器控制从服务器同意删除过期键，保证主从服务器的数据一致性</p><ul><li>主服务器在删除一个过期键之后，会显式地向所有从服务器发送一个DEL命令，告知从服务器删除这个过期键</li><li>从服务器执行读命令时，即使碰到过期键也不会删除，继续像处理未过期键一样来处理</li><li>从服务器只有在接到主服务器发来的DEL命令之后，才会删除过期键</li></ul></li></ul><h3 id="_5、数据库通知" tabindex="-1"><a class="header-anchor" href="#_5、数据库通知"><span>5、数据库通知</span></a></h3><ul><li>键空间通知：关于&quot;某个键执行了什么命令&quot;的通知 <code>SUBSCRIBE __keyspace@0__:&lt;key&gt;</code></li><li>键事件通知：关于&quot;某个命令被什么键执行&quot;的通知 <code>SUBSCRIBE __keyevent@0__:&lt;opt&gt;</code></li><li>服务器配置的notify-keyspace-events选项决定了服务器所发送通知的类型</li><li>底层由<code>notify.c/notifyKeyspaceEvent(type, event, key, bdid)</code>函数实现</li></ul><h2 id="二、rdb持久化" tabindex="-1"><a class="header-anchor" href="#二、rdb持久化"><span>二、RDB持久化</span></a></h2><p>Redis提供RDB持久化功能，将内存数据保存到磁盘，生成经过压缩的二进制文件，避免数据丢失。</p><h3 id="_1、rdb文件的创建与载入" tabindex="-1"><a class="header-anchor" href="#_1、rdb文件的创建与载入"><span>1、RDB文件的创建与载入</span></a></h3><ul><li><p>创建：</p><ul><li>SAVE：阻塞服务器进程，由主线程执行保存。 <ul><li>执行期间，所有客户端命令都会被拒绝</li></ul></li><li>BGSAVE：创建子进程执行保存 <ul><li>执行期间，新的SAVE、BGSAVE命令会被拒绝，防止竞争</li><li>执行期间，新的BGREWRITEAOF命令延迟到保存任务结束执行</li><li>出于性能考虑，BGREWRITEAOF命令执行期间，新的BGSAVE命令会被拒绝</li></ul></li></ul></li><li><p>载入：</p><ul><li>服务器启动时自动载入，但优先级低于AOF文件</li><li>载入期间，服务器一直处于阻塞状态</li></ul></li></ul><h3 id="_2、自动保存" tabindex="-1"><a class="header-anchor" href="#_2、自动保存"><span>2、自动保存</span></a></h3><p>serverCron服务器周期性函数每隔100ms执行一次维护，其中包括RDB保存。触发的条件由配置中的save选项定义，程序会遍历并检查saveparams数组中的所有保存条件,只要任何一个满足，将自动执行BGSAVE命令。</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token comment"># save &lt;time&gt; &lt;changes&gt;</span>
<span class="token comment"># 服务器在900秒之内，对数据库进行了至少1次修改。</span>
<span class="token key attr-name">save</span> <span class="token value attr-value">900 1 </span>
<span class="token comment"># 服务器在300秒之内，对数据库进行了至少10次修改。</span>
<span class="token key attr-name">save</span> <span class="token value attr-value">300 10</span>
<span class="token comment">#服务器在60秒之内，对数据库进行了至少10000次修改。</span>
<span class="token key attr-name">save</span> <span class="token value attr-value">60 10000</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在实现上：redisServer结构的</p><ul><li>saveparams数组保存触发条件</li><li>dirty计数器记录上次成功执行SAVE/BGSAVE后，所有数据库修改的总次数（每个键算一次）</li><li>lastsave属性记录上次成功执行SAVE/BGSAVE的时间</li></ul><h3 id="_3、rdb文件结构" tabindex="-1"><a class="header-anchor" href="#_3、rdb文件结构"><span>3、RDB文件结构</span></a></h3><p><strong>整体结构:</strong></p>`,16),x=l("img",{src:_,style:{zoom:"50%"}},null,-1),B=l("ul",null,[l("li",null,"REDIS：RDB文件常量标志，占5Byte"),l("li",null,"db_version: RDB文件版本号，占4Byte"),l("li",null,"databases: 包含所有数据库数据，长度由数据库数据决定"),l("li",null,"EOF：末尾常量标记，占1ByteREDIS_ENCODING_"),l("li",null,"check_sum: 前4个字段的校验和，占8byte长的无符号整数")],-1),S=l("p",null,[l("strong",null,"database部分:")],-1),k=l("img",{src:p,style:{zoom:"50%"}},null,-1),C=l("ul",null,[l("li",null,"SELECTDB: 标记下一个将读入数据库编号，占1Byte"),l("li",null,"db_number: 数据库编号，占1/2/5Byte。读入后调用SELECT切换数据库"),l("li",null,"key_value_pairs: 所有数据库的键值对数据，以及可选的过期时间")],-1),I=l("p",null,[l("strong",null,"key_value_pairs部分:")],-1),O=l("img",{src:T,style:{zoom:"50%"}},null,-1),F=l("ul",null,[l("li",null,"EXPIRETIME_MS: 可选，标记下一个将读入以ms为单位的过期时间，占1Byte"),l("li",null,"ms: 可选，UNIX时间戳，8Byte有符号整数"),l("li",null,"TYPE: 值对象类型/底层编码"),l("li",null,"key: 字符串对象表示的键"),l("li",null,"value: 值对象")],-1),M=l("p",null,[l("strong",null,"value部分:")],-1),H=l("img",{src:Q,style:{zoom:"50%"}},null,-1),N=l("li",null,[e("如果是"),l("code",null,"REDIS_ENCODING_INT"),e("，则以 "),l("code",null,"ENCODING+integer"),e(" 的形式保存，ENCODING标记占8/16/32位长")],-1),Z=l("code",null,"REDIS_ENCODING_RAW",-1),w={class:"MathJax",jax:"SVG",style:{position:"relative"}},V={style:{"vertical-align":"-0.464ex"},xmlns:"http://www.w3.org/2000/svg",width:"11.108ex",height:"2.009ex",role:"img",focusable:"false",viewBox:"0 -683 4909.8 888","aria-hidden":"true"},P=i('<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><g data-mml-node="text"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"></path></g><g data-mml-node="text" transform="translate(778,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g></g><g data-mml-node="mn" transform="translate(1833.8,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"></path></g><g data-mml-node="mi" transform="translate(2833.8,0)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g><g data-mml-node="mi" transform="translate(3592.8,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(4082.8,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mi" transform="translate(4443.8,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g></g></g>',1),G=[P],z=l("mjx-assistive-mml",{unselectable:"on",display:"inline"},[l("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[l("mo",null,"<="),l("mn",null,"20"),l("mi",null,"B"),l("mi",null,"y"),l("mi",null,"t"),l("mi",null,"e")])],-1),U=l("code",null,"len+string",-1),Y={class:"MathJax",jax:"SVG",style:{position:"relative"}},W={style:{"vertical-align":"-0.464ex"},xmlns:"http://www.w3.org/2000/svg",width:"9.348ex",height:"2.009ex",role:"img",focusable:"false",viewBox:"0 -683 4131.8 888","aria-hidden":"true"},j=i('<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"></path></g><g data-mml-node="mn" transform="translate(1055.8,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"></path></g><g data-mml-node="mi" transform="translate(2055.8,0)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g><g data-mml-node="mi" transform="translate(2814.8,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(3304.8,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mi" transform="translate(3665.8,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g></g></g>',1),q=[j],K=l("mjx-assistive-mml",{unselectable:"on",display:"inline"},[l("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[l("mo",null,">"),l("mn",null,"20"),l("mi",null,"B"),l("mi",null,"y"),l("mi",null,"t"),l("mi",null,"e")])],-1),J=l("code",null,"REDIS_RDB_ENC_LZF+compressed_len+origin_len+compressed_string ",-1),X=i("<li>列表对象： <ul><li>TYPE为<code>REDIS_RDB_TYPE_LIST</code>，以<code>list_length+itemN+...</code>的形式保存</li><li>每个item按字符串对象保存</li></ul></li><li>集合对象： <ul><li>TYPE为<code>REDIS_RDB_TYPE_SET</code>，以 <code>set_size+elemN+... </code>的形式保存</li><li>每个elem按字符串对象保存</li></ul></li><li>哈希表对象： <ul><li>TYPE为<code>REDIS_RDB_TYPE_HASH</code>，以 <code>hash_size+keyN+valueN+... </code>的形式保存</li><li>每个键、值按字符串对象相邻保存</li></ul></li><li>有序集合对象： <ul><li>TYPE为<code>REDIS_RDB_TYPE_ZSET</code>，以 <code>sorted_set_size+memberN+scoreN+... </code>的形式保存</li><li>每个成员、分值按字符串对象相邻保存</li><li>分值由double转为字符串，载入时自动转换</li></ul></li><li>INTSET编码和集合： <ul><li>TYPE为<code>REDIS_RDB_TYPE_SET_INTSET</code>，将整数转为字符串，按字符串对象保存</li></ul></li><li>ZIPLIST编码的列表、哈希表、有序集合： <ul><li>TYPE为<code>REDIS_RDB_TYPE_LIST|HASH|ZSET_ZIPLIST</code>，将压缩列表类型的value转为字符串对象</li></ul></li>",6),$=i('<h3 id="_4、分析rdb文件" tabindex="-1"><a class="header-anchor" href="#_4、分析rdb文件"><span>4、分析RDB文件</span></a></h3><p><code>od -cx dump.rdb</code> 以ASCII和16进制打开RDB文件 <code>redis-check-dump</code> 工具</p><h2 id="三、aof持久化" tabindex="-1"><a class="header-anchor" href="#三、aof持久化"><span>三、AOF持久化</span></a></h2><p>除了RDB持久化，Redis还提供AOF（Append Only File），通过保存所执行的写命令实现持久化。</p><h3 id="_1、实现-1" tabindex="-1"><a class="header-anchor" href="#_1、实现-1"><span>1、实现</span></a></h3><ul><li>命令追加：服务器每执行完一个写命令，以协议格式将被执行的命令追加到redisServer的<code>aof_buf</code>缓冲区</li><li>写入与同步： <ul><li>Redis服务器进程本质上是一个事件循环，其中文件事件负责处理客户端请求，时间事件负责执行<code>serverCron</code>这样定时运行的函数 <ul><li>每结束一个事件循环，会调用<code>flushAppendOnlyFile</code>函数，决定是否将<code>aof_buf</code>写入AOF文件中</li></ul></li><li>同步行为由<code>appendfsync</code>选项值决定： <ul><li><code>always</code>：每次有数据修改发生时都会写入AOF文件。效率最慢，安全性最高</li><li><code>everysec</code>：<strong>默认</strong>，每秒钟同步一次，显式地将多个写命令同步到硬盘。效率适中</li><li><code>no</code>：由 OS 决定何时进行同步。效率最高安全性最差</li></ul></li></ul></li><li>载入数据：创建不带网络连接的伪客户端（上下文），读取、分析并执行AOF文件中的每一条命令。</li></ul><h3 id="_2、aof重写" tabindex="-1"><a class="header-anchor" href="#_2、aof重写"><span>2、AOF重写</span></a></h3><p>为了避免大量写命令造成AOF文件体积过大，以及还原时间过长，需要用BGREWRITEAOF命令对AOF文件重写。</p><ul><li>本质上并不读取旧AOF文件，而是创建一个新文件，直接读取数据库状态，然后将数据写入新AOF文件</li><li>为了避免客户端输入缓冲区溢出，处理列表,哈希表,集合,有序集合这四种可能会带有多个键,对于超过<code>REDIS_AOF_REWRITE_ITEMS_PER_CMD</code>数量的键，分多条命令写入</li><li>Redis使用子进程执行重写 <ul><li>优点：不阻塞服务器进程，且子进程带有服务器进程的数据副本，避免用锁保证数据安全</li><li>问题：重写过程中与服务器进程的数据不一致性。</li><li>解决方案： <ul><li>子进程执行重写的过程中，新的客户端命令不仅要追加到aof_buf，还要追加到<code>aof_rewrite_buf</code></li><li>子进程完成重写后，向服务器进程发送信号。由主进程将<code>aof_rewrite_buf</code>写入AOF文件，保证数据一致性</li><li>最后以原子操作，将新AOF文件改名覆盖旧AOF文件</li></ul></li></ul></li></ul><h2 id="四、事件" tabindex="-1"><a class="header-anchor" href="#四、事件"><span>四、事件</span></a></h2><p>Redis服务器是基于Reactor模式的事件驱动程序，主要处理两类事件：</p><ul><li>文件事件：服务器与客户端通信，对套接字操作的抽象</li><li>时间事件：定时操作的抽象</li></ul><h3 id="_1、文件事件" tabindex="-1"><a class="header-anchor" href="#_1、文件事件"><span>1、文件事件</span></a></h3>',13),ll=l("img",{src:m,style:{zoom:"33%"}},null,-1),el=i("<ul><li>套接字：文件事件的抽象，每当一个套接字准备好执行连接应答、写入、读取、关闭等操作时，就会产生一个文件事件 <ul><li>复用程序可以监听套接字的<code>AE_READABLE</code> | <code>AE_WRITABLE</code>事件</li><li>也可以同时监听<code>AE_READABLE</code>、<code>AE_WRITABLE</code>，如果同时产生事件，服务器将先读后写</li></ul></li><li>I/O多路复用程序：负责监听多个套接字，并向文件事件分派器传送那些产生了事件的套接字 <ul><li>所有产生事件的套接字都会放到一个队列里，然后以有序、同步、每次一个套接字的方式传送套接字</li><li>当上一个套接字产生的事件被处理完毕之后，才会继续传送下一个套接字</li><li>实现上通过包装常见的I/O多路复用库，如select, epoll, evport, kqueue等，且提供相同的API，编译时自动选择性能最高的函数库</li></ul></li><li>文件事件分派器：接收I/O多路复用程序传来的套接字，并根据套接字产生的事件的类型调用相应的事件处理器</li><li>事件处理器：与不同任务的套接字关联的一个个函数，定义了某个事件发生时服务器应该执行的动作。常用的有三类： <ul><li>连接应答处理器：acceptTcpHandler函数，用于对连接服务器监听套接字的客户端进行应答</li><li>命令请求处理器：readQueryFromClient函数，负责从套接字中读入客户端发送的命令请求内容</li><li>命令回复处理器：sendReplyToClient函数，负责将服务器执行命令后得到的回复通过套接字返回给客户端</li></ul></li></ul>",1),il=l("img",{src:g,style:{zoom:"33%"}},null,-1),tl=i('<h3 id="_2、时间事件" tabindex="-1"><a class="header-anchor" href="#_2、时间事件"><span>2、时间事件</span></a></h3><p>一个时间事件主要有三个属性组成：</p><ul><li>id：服务器为时间事件创建的全局唯一ID。ID从小到大递增</li><li>when：毫秒精度的UNIX时间戳，记录了时间事件的到达时间</li><li>timeProc：时间事件处理器，一个函数。当时间事件到达时，服务器就会调用相应的处理器来处理事件</li></ul><p>Redis的时间事件分定时事件和周期性事件两类，目前仅使用周期性事件。类型取决于处理器的返回值：</p><ul><li>AE_NOMORE：定时事件，到达一次后就删除</li><li>非AE_NOMORE 周期性事件，根据返回值对事件的when属性更新，继续运行</li></ul><p>实现上，服务器将所有时间事件放在一个无序链表（不按when属性排序，按id）中，每当时间事件执行器运行时，遍历整个链表，查找已到达的事件并调用相应的处理器。不过目前Redis仅有serverCron一个时间事件，因此实际上该链表仅一个节点。serverCron函数的工作包括：</p><ul><li>更新服务器的各类统计信息，比如时间、内存占用、数据库占用情况等。</li><li>清理数据库中的过期键值对。</li><li>关闭和清理连接失效的客户端。</li><li>尝试进行AOF或RDB持久化操作。</li><li>如果服务器是主服务器，那么对从服务器进行定期同步。</li><li>如果处于集群模式，对集群进行定期同步和连接测试。</li></ul><h3 id="_3、事件的调度与执行" tabindex="-1"><a class="header-anchor" href="#_3、事件的调度与执行"><span>3、事件的调度与执行</span></a></h3>',8),sl=l("img",{src:E,style:{zoom:"33%"}},null,-1),al=i('<ul><li>等待文件事件产生调用的是aeApiPoll，阻塞时间由到达时间最接近当前时间的时间事件决定，避免对时间事件频繁轮询也避免阻塞时间过长</li><li>文件事件是随机出现的，如果处理完一次文件事件，没有时间事件到达，将再次等待处理文件事件</li><li>对事件的处理都是同步、有序、原子的，不会中断也不会抢占。但都会尽量减少阻塞时间，并在需要时让出执行权</li><li>时间事件在文件事件之后，且不会抢占，因此时间事件的实际执行通常比设定时间稍晚一些</li></ul><h2 id="五、客户端" tabindex="-1"><a class="header-anchor" href="#五、客户端"><span>五、客户端</span></a></h2><p>Redis是一对多的服务器程序，通过I/O多路复用实现单线程单进程处理所有客户端的命令请求。redisServer中的clients指针指向了保存所有客户端状态的redisClient结构数组。</p><h3 id="_1、通用属性" tabindex="-1"><a class="header-anchor" href="#_1、通用属性"><span>1、通用属性</span></a></h3><ul><li>fd: 客户端正在使用的套接字描述符 <ul><li>值 -1 表示伪客户端，包括AOF载入和Lua脚本两种场景</li><li>大于-1的整数即普通客户端</li></ul></li><li>name: 通过<code>CLIENT name xxx</code>设置，让客户端身份更清晰</li><li>flags：各种状态信息标志位</li><li>querybuf：输入缓冲区，根据输入动态调节，最大1GB</li><li>argv、argc：命令参数和数量</li><li>cmd：命令函数，redisCommand类型</li><li>buf、bufpos：固定大小的输出缓冲区和已使用大小，保存长度较小的回复</li><li>reply：可变大小的输出缓冲区，链表结构，保存长度较大的回复</li><li>authenticated：身份认证，0未通过，1通过。未通过时除AUTH命令外都会被拒绝执行</li><li>ctime：客户端创建时间</li><li>lastinteraction：上一次交互时间</li><li>obuf_soft_limit_reached_time：输出缓冲区第一次到达软性限制的时间 <ul><li>服务器使用两种模式限制输出缓冲区大小，一种硬限制，超过即关闭客户端</li><li>另一种是软限制，超过后继续监测，如果持续一段时间（配合readched_time）一直超过则关闭。</li></ul></li></ul><h3 id="_2、创建与连接" tabindex="-1"><a class="header-anchor" href="#_2、创建与连接"><span>2、创建与连接</span></a></h3><ul><li>普通客户端： <ul><li>创建：通过网络连接，创建相应的redisClient，加入服务器状态的clients链表末尾</li><li>关闭：进程结束、请求不符合协议、KILL、timeout、I/O缓冲区溢出...</li><li>注意:为了避免客户端回复过大,占用过多服务器资源,服务器会时刻检查客户端的输出缓冲区大小,并在缓冲区的大小超出范围时执行相应的限制操作 <ul><li>硬性限制:如果缓冲区大小超过硬性限制所设置的大小,会立刻关闭客户端</li><li>软性限制:只有一直超出软性限制并且持续时间超出服务器设置的时长才会关闭客户端,如果缓冲区大小在指定时间内不再超出软性限制就不会关闭客户端</li></ul></li></ul></li><li>Lua伪客户端：服务器初始化时创建负责执行Lua脚本的伪客户端，关联在redisServer/lua_client属性中，直到服务器销毁时才会关闭。</li><li>AOF伪客户端：服务器载入AOF文件时，会创建用于执行AOF文件的伪客户端，载入完成后关闭。</li></ul><h2 id="六、服务器" tabindex="-1"><a class="header-anchor" href="#六、服务器"><span>六、服务器</span></a></h2><h3 id="_1、命令执行过程" tabindex="-1"><a class="header-anchor" href="#_1、命令执行过程"><span>1、命令执行过程</span></a></h3><ul><li>发送命令请求：用户键入命令请求，客户端将其转换成协议格式，然后通过连接套接字发送给服务器</li><li>读取命令请求： <ul><li>服务器读取套接字中的请求，保存到redisClient的输入缓冲区</li><li>分析缓冲区内的请求，提取命令参数及个数，保存到argv、argc</li><li>调用命令执行器，执行指定命令</li></ul></li><li>发送命令回复： <ul><li>命令实现函数将回复保存在redisClient的输出缓冲区</li><li>服务器通过命令回复处理器，将回复发送给客户端，并清空缓冲区</li></ul></li><li>接收命令回复：客户端接收回复并转换协议，打印出结果</li></ul><h3 id="_2、命令执行过程" tabindex="-1"><a class="header-anchor" href="#_2、命令执行过程"><span>2、命令执行过程</span></a></h3><p>根据redisClient的argv[0]在命令表中查找命令实现，即redisCommand结构，记录至cmd属性。主要属性有：</p><ul><li>name, proc实现函数, arity参数个数, sflags标记位, calls执行次数, milliseconds执行时长...</li></ul>',13),nl=l("img",{src:v,style:{zoom:"33%"}},null,-1),dl=i('<ul><li>执行预备操作：检查cmd非NULL，检查命令参数，身份验证，内存占用，持久化/订阅/Lua/监视器等检查工作</li><li>调用命令实现函数： <ul><li>调用redisClient-&gt;cmd-&gt;proc(client)</li><li>执行结果保存至输出缓冲区（buf/reply）</li><li>为客户端套接字关联回复处理器</li></ul></li><li>执行后续工作： <ul><li>跟新慢查询日志</li><li>更新redisClient相关属性</li><li>AOF同步</li><li>主从同步</li></ul></li></ul><h3 id="_3、servercron函数" tabindex="-1"><a class="header-anchor" href="#_3、servercron函数"><span>3、serverCron函数</span></a></h3><ol><li>更新服务器时间缓存，redisServer/unixtime、mstime <ul><li>serverCron每100ms执行一次，因此时间精度不高</li><li>仅用于对时间精度要求不高的功能，如打印日志、更新LRU时钟等</li><li>而需要高精度时间的任务，如设置过期时间、添加慢查询日志等，仍然执行系统调用获取准确时间</li></ul></li><li>更新LRU时钟：对象最后一次被访问时间，估算值</li><li>更新服务器每秒执行命令次数：INFO status 命令的 instantaneous_ops_per_sec 属性，实现上是采样平均得到的估算值</li><li>更新服务器内存峰值记录：redisServer/stat_peak_memory</li><li>处理SIGTERM结束服务器信号,关闭之前会进行RDB持久化</li><li>管理客户端资源：释放超时的客户端连接、重置溢出的客户端输入缓冲区</li><li>管理数据库资源：删除过期键、收缩字典</li><li>执行被延迟的BGREWRITEAOF</li><li>检查持久化操作的运行状态：redisServer/rdb_child_pid, aof_child_pid记录执行持久化的子进程</li></ol>',3),rl=l("img",{src:b,style:{zoom:"33%"}},null,-1),ol=i('<ol start="11"><li><p>同步AOF文件</p></li><li><p>关闭输出缓冲区溢出的客户端</p></li><li><p>增加cronloops计数器，记录serverCron执行次数</p></li></ol><h3 id="_4、初始化服务器" tabindex="-1"><a class="header-anchor" href="#_4、初始化服务器"><span>4、初始化服务器</span></a></h3><ul><li>初始化服务器状态结构：initServerConfig函数 <ul><li>设置服务器运行id、频率、配置文件路径、架构、端口、持久化条件，初始化LRU时钟，并创建命令表</li></ul></li><li>载入配置选项：通过给定配置参数/配置文件，修改服务器的默认配置</li><li>初始化服务器数据结构：initServer函数 <ul><li>server.clients: redisClient数组</li><li>server.db: 数据库结构数组</li><li>server.pubsub_channels/patterns: 保存频道订阅信息的字典、保存模式订阅信息的链表</li><li>server.lua: 执行Lua脚本的Lua环境</li><li>server.slowlog: 保存慢查询日志的结构</li><li>其它操作：设置进程信号处理器、创建共享对象、打开监听端口、创建时间事件、AOF持久化、初始化后台I/O</li></ul></li><li>还原数据库状态：如果启用AOF，则用AOF文件还原，否则使用RDB文件</li><li>执行事件循环：可以开始接收客户端连接和请求</li></ul>',3);function cl(ul,hl){const t=o("center");return d(),n("div",null,[c("more"),R,s(t,null,{default:a(()=>[D]),_:1}),y,s(t,null,{default:a(()=>[A]),_:1}),L,s(t,null,{default:a(()=>[x]),_:1}),B,S,s(t,null,{default:a(()=>[k]),_:1}),C,I,s(t,null,{default:a(()=>[O]),_:1}),F,M,s(t,null,{default:a(()=>[H]),_:1}),l("ul",null,[l("li",null,[e("字符串对象： "),l("ul",null,[N,l("li",null,[e("如果是"),Z,e("，则保存的是字符串 "),l("ul",null,[l("li",null,[e("对于长度"),l("mjx-container",w,[(d(),n("svg",V,G)),z]),e("的串，以 "),U,e(" 的形式保存")]),l("li",null,[e("对于长度"),l("mjx-container",Y,[(d(),n("svg",W,q)),K]),e("的串，以 "),J,e("的形式保存，其中REDIS_RDB_ENC_LZF是LZF压缩算法标记")])])])])]),X]),$,s(t,null,{default:a(()=>[ll]),_:1}),el,s(t,null,{default:a(()=>[il]),_:1}),tl,s(t,null,{default:a(()=>[sl]),_:1}),al,s(t,null,{default:a(()=>[nl]),_:1}),dl,s(t,null,{default:a(()=>[rl]),_:1}),ol])}const Tl=r(f,[["render",cl],["__file","22_redis单机.html.vue"]]),Ql=JSON.parse('{"path":"/posts/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/22_redis%E5%8D%95%E6%9C%BA.html","title":"Redis单机","lang":"zh-CN","frontmatter":{"title":"Redis单机","date":"2024-11-27T16:14:58.000Z","tags":"redis","category":"数据库","order":22,"icon":"/img/redis.svg","description":"Redis单机 一、数据库 1、实现 Redis服务器将所有数据库都保存在服务器状态redis.h/redisServer结构的db数组中，db数组的每个项都是一个redis.h/redisDb结构，每个redisDb结构代表一个数据库。数组长度（数据库数量）由dbnum控制，默认有16个，通过SELECT命令切换数据库。 RedisClient结构中...","head":[["meta",{"property":"og:url","content":"https://mister-hope.github.io/posts/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/22_redis%E5%8D%95%E6%9C%BA.html"}],["meta",{"property":"og:site_name","content":"Lance"}],["meta",{"property":"og:title","content":"Redis单机"}],["meta",{"property":"og:description","content":"Redis单机 一、数据库 1、实现 Redis服务器将所有数据库都保存在服务器状态redis.h/redisServer结构的db数组中，db数组的每个项都是一个redis.h/redisDb结构，每个redisDb结构代表一个数据库。数组长度（数据库数量）由dbnum控制，默认有16个，通过SELECT命令切换数据库。 RedisClient结构中..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-11-27T06:47:17.000Z"}],["meta",{"property":"article:author","content":"RuyiWei"}],["meta",{"property":"article:published_time","content":"2024-11-27T16:14:58.000Z"}],["meta",{"property":"article:modified_time","content":"2024-11-27T06:47:17.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Redis单机\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2024-11-27T16:14:58.000Z\\",\\"dateModified\\":\\"2024-11-27T06:47:17.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"RuyiWei\\"}]}"]]},"headers":[{"level":2,"title":"一、数据库","slug":"一、数据库","link":"#一、数据库","children":[{"level":3,"title":"1、实现","slug":"_1、实现","link":"#_1、实现","children":[]},{"level":3,"title":"2、键空间","slug":"_2、键空间","link":"#_2、键空间","children":[]},{"level":3,"title":"3、过期回收","slug":"_3、过期回收","link":"#_3、过期回收","children":[]},{"level":3,"title":"4、AOF、RDB和复制功能对过期键的处理","slug":"_4、aof、rdb和复制功能对过期键的处理","link":"#_4、aof、rdb和复制功能对过期键的处理","children":[]},{"level":3,"title":"5、数据库通知","slug":"_5、数据库通知","link":"#_5、数据库通知","children":[]}]},{"level":2,"title":"二、RDB持久化","slug":"二、rdb持久化","link":"#二、rdb持久化","children":[{"level":3,"title":"1、RDB文件的创建与载入","slug":"_1、rdb文件的创建与载入","link":"#_1、rdb文件的创建与载入","children":[]},{"level":3,"title":"2、自动保存","slug":"_2、自动保存","link":"#_2、自动保存","children":[]},{"level":3,"title":"3、RDB文件结构","slug":"_3、rdb文件结构","link":"#_3、rdb文件结构","children":[]},{"level":3,"title":"4、分析RDB文件","slug":"_4、分析rdb文件","link":"#_4、分析rdb文件","children":[]}]},{"level":2,"title":"三、AOF持久化","slug":"三、aof持久化","link":"#三、aof持久化","children":[{"level":3,"title":"1、实现","slug":"_1、实现-1","link":"#_1、实现-1","children":[]},{"level":3,"title":"2、AOF重写","slug":"_2、aof重写","link":"#_2、aof重写","children":[]}]},{"level":2,"title":"四、事件","slug":"四、事件","link":"#四、事件","children":[{"level":3,"title":"1、文件事件","slug":"_1、文件事件","link":"#_1、文件事件","children":[]},{"level":3,"title":"2、时间事件","slug":"_2、时间事件","link":"#_2、时间事件","children":[]},{"level":3,"title":"3、事件的调度与执行","slug":"_3、事件的调度与执行","link":"#_3、事件的调度与执行","children":[]}]},{"level":2,"title":"五、客户端","slug":"五、客户端","link":"#五、客户端","children":[{"level":3,"title":"1、通用属性","slug":"_1、通用属性","link":"#_1、通用属性","children":[]},{"level":3,"title":"2、创建与连接","slug":"_2、创建与连接","link":"#_2、创建与连接","children":[]}]},{"level":2,"title":"六、服务器","slug":"六、服务器","link":"#六、服务器","children":[{"level":3,"title":"1、命令执行过程","slug":"_1、命令执行过程","link":"#_1、命令执行过程","children":[]},{"level":3,"title":"2、命令执行过程","slug":"_2、命令执行过程","link":"#_2、命令执行过程","children":[]},{"level":3,"title":"3、serverCron函数","slug":"_3、servercron函数","link":"#_3、servercron函数","children":[]},{"level":3,"title":"4、初始化服务器","slug":"_4、初始化服务器","link":"#_4、初始化服务器","children":[]}]}],"git":{"createdTime":1732619412000,"updatedTime":1732690037000,"contributors":[{"name":"weiruyi","email":"1581778251@qq.com","commits":2}]},"readingTime":{"minutes":17.52,"words":5257},"filePathRelative":"posts/后端/数据库/22_redis单机.md","localizedDate":"2024年11月27日","excerpt":"<!--more-->\\n<h1>Redis单机</h1>\\n<h2>一、数据库</h2>\\n<h3>1、实现</h3>\\n<p>Redis服务器将所有数据库都保存在服务器状态redis.h/redisServer结构的db数组中，db数组的每个项都是一个redis.h/redisDb结构，每个redisDb结构代表一个数据库。数组长度（数据库数量）由dbnum控制，默认有16个，通过<code>SELECT</code>命令切换数据库。</p>\\n<p>RedisClient结构中的db属性指向当前所使用的数据库，SELECT命令原理即修改该指针。</p>\\n\\n<h3>2、键空间</h3>\\n<p>Redis是一个键值对K-V数据库服务器，服务器中的每个数据库都由一个redis.h/redisDb结构表示，其中，redisDb结构的dict字典保存了数据库中的所有键值对，这个字典称为键空间（key space）。所有针对数据库中数据的操作本质上都是对键空间字典的操作，同时也会进行一些维护：</p>","autoDesc":true}');export{Tl as comp,Ql as data};
